From 474ee842f5779eee2f63cb22c9aecb54493afd04 Mon Sep 17 00:00:00 2001
From: David Scott <dave.scott@docker.com>
Date: Thu, 23 Jan 2020 20:15:15 +0000
Subject: [PATCH 33/33] fuse: localise cache invalidation

Consider squashing into the previous commit

Signed-off-by: David Scott <dave.scott@docker.com>
---
 fs/fuse/dir.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/fs/fuse/dir.c b/fs/fuse/dir.c
index 465eb86..733e662 100644
--- a/fs/fuse/dir.c
+++ b/fs/fuse/dir.c
@@ -130,8 +130,7 @@ void fuse_invalidate_entry_cache(struct dentry *entry)
  */
 static void fuse_invalidate_entry(struct dentry *entry)
 {
-	printk("skipping fuse_invalidate_entry's d_invalidate\n");
-	/* d_invalidate(entry); -- skip to avoid "deleting" current working dirs */
+	d_invalidate(entry);
 	fuse_invalidate_entry_cache(entry);
 }
 
@@ -986,7 +985,8 @@ int fuse_reverse_inval_entry(struct super_block *sb, u64 parent_nodeid,
 		goto unlock;
 
 	fuse_dir_changed(parent);
-	fuse_invalidate_entry(entry);
+	printk("fuse_invalidate_entry skipping d_invalidate for %s\n", name->name);
+	fuse_invalidate_entry_cache(entry);
 
 	if (child_nodeid != 0 && d_really_is_positive(entry)) {
 		inode_lock(d_inode(entry));
-- 
2.7.4

